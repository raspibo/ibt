<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Makerspace booking</title>
  <link rel="stylesheet" href="css/themes/smoothness/jquery-ui.css">
  <script src="js/jquery-1.11.0.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/backbone-min.js"></script>
  <script src="js/ibt-init.js"></script>
  <!-- script src="js/ibt-i18n-it.js"></script -->
  <script src="js/ibt-backbone.js"></script>
  <link rel="stylesheet" href="css/main.css">
  <script>

// Enabled dates in the shown month.
ibt.enabledDatesOfMonth = [];


/** Enable days in the calendar according to the content
    of ibt.enabledDatesOfMonth. */
function cbShowDay(date) {
	var enabled = false;
	var cls = '';
	if (ibt.enabledDatesOfMonth.indexOf(date.getDate()) > -1) {
		enabled = true;
		cls = 'selectable-date';
	}
	return [enabled, cls, ''];
}

/** Update the list of enabled days when the month changes. */
function cbChangeMonthYear(year, month, dp) {
	ibt.info('cbChangeMonthYear year:' + year + ' month:' + month);
	$.ajax({
		url: '/utils/valid-dates-in-month',
		dataType: 'json',
		data: {year: year, month: month}
	}).done(function(data) {
		ibt.info(['received data:', data]);
		ibt.enabledDatesOfMonth = data;
		$("#datepicker").datepicker('refresh');
	}).fail(function(jqXHR, textStatus, errorThrown) {
		ibt.error(['unable to connect; textStatus:',
			textStatus, 'errorThrown:', errorThrown]);
		ibt.enabledDatesOfMonth = [];
	});
}

/** Show information about the selected day. */
function cbOnSelect(dateFormat, dp) {
	ibt.debug('cbOnSelect');
	var day = dp.selectedDay;
	if (day < 10) {
		day = '0' + day;
	}
	var month = dp.selectedMonth + 1;
	if (month < 10) {
		month = '0' + month;
	}
	var iso8601date = '' + dp.selectedYear + '-' + month + '-' + day;
	//$("#select-a-date").text(iso8601date);
	ibt.app.dateChanged(iso8601date);
}


// Configuration for the datepicker instance.
var datepickerOpts = {
	showAnim: 'fadeIn',
	beforeShowDay: cbShowDay,
	dateFormat: 'ISO_8601',
	firstDay: 1,
	onSelect: cbOnSelect,
	onChangeMonthYear: cbChangeMonthYear,
};


/* Bootstrap the app. */
$(document).ready(function() {

	/** View for a single group. */
	ibt.GroupView = Backbone.View.extend({
		tagName: 'li',
		className: 'group-item',
		template: _.template($('#group-template').html()),
		events: {
			'keypress .add-user': 'addUser',
			'click .destroy-user': 'removeUser',
		},

		initialize: function(args) {
			this.listenTo(this.model, 'sync', this.render);
		},

		render: function() {
			ibt.debug('ibt.GroupView.render');
			this.$el.html(this.template(this.model.attributes));
			return this;
		},

		addUser: function(evt) {
			if (evt.keyCode != 13) {
				return;
			}
			var name = this.$('.add-user').val();
			if (!name) {
				return;
			}
			var attendants = this.model.get('attendants') || [];
			if (this.userInList(name, attendants)) {
				ibt.warn('not adding duplicated user; name:' + name);
				return;
			}
			ibt.info('adding new user:' + name +
				' to group:' + this.model.get('group'));
			attendants.push({name: name});
			this.model.set('attendants', attendants);
			this.model.save();
		},

		removeUser: function(evt) {
			var name = $(evt.currentTarget).attr('name');
			if (!name) {
				return;
			}
			var currentAttendants = this.model.get('attendants') || [];
			var attendants = _.filter(
				currentAttendants,
				function(person) { return person.name != name; }
			);
			if (currentAttendants.length == attendants.length) {
				ibt.warn('user not removed; name:' + name);
				return;
			}
			ibt.info('removing user; name:' + name);
			this.model.set('attendants', attendants);
			this.model.save();
		},

		userInList: function(name, list) {
			if (list === undefined) {
				list = this.model.get('attendants') || [];
			}
			duplicated = false;
			_.each(list, function(person) {
				if (name == person.name) {
					duplicated = true;
					return;
				}
			});
			return duplicated;
		}
	});

	ibt.groupsContainer = new ibt.Groups();
	ibt.app = new ibt.AppView({
		el: $('#panel'),
		groupsContainer: ibt.groupsContainer,
		GroupView: ibt.GroupView
	});

	$("#datepicker").datepicker(datepickerOpts);
	// beforeShow seems to not work properly, in this case.
	var now = new Date();
	cbChangeMonthYear(now.getFullYear(), now.getMonth()+1, dp);

});
  </script>
</head>
<body>

<h1>RaspiBO: makerspace booking</h1>

<script type="text/template" id="group-template">
<div class="group-name" value="<%- group %>"><%= i18n('Group')%>: <%- group %><% if (!group) { %><input type="text" size="20" /><% } %></div>
<div class="group-attendants">
	<%= i18n('Attendants')%>:
	<ul class="group-attendants-list">
	  <% _.each(attendants, function(person) { %><li><span class="user-name" value="<%- person.name %>"><%- person.name %></span><span style="float:right;"><a href="#" class="destroy destroy-user" name="<%- person.name %>">[x]</a></span></li> <% }); %>
	  <li><input type="text" size="20" class="add-user" /></li>
	</ul>
</div>
</script>

<div id="container">
<div id="dp">
Date: <div id="datepicker"></div>
</div>

<div id="panel">
	<div id="select-a-date">Please select a day from the date picker.</div>
	<div id="curent-date"></div>
	<div id="active">
		<ul id="groups-list"></ul>
	</div>

</div>

</div>

</body>
</html>
